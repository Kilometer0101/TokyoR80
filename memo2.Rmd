---
title: "初めてのreticulate"
author: "km"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(reticulate)
```

##### [Python環境構築](memo.html)→初めてのreticulate(ｲﾏｺｺ)

## 要件

**reticulate**パッケージを使ってR上でPythonを使う。

## Python側の準備

[環境構築](memo.html)を参照。

`Pipenv`で作った仮想環境が入ったフォルダに移動し、インタープリタのpathを確認。

```{bash, eval = F}
cd <hoge>/project   # 移動
pipenv shell        # 環境に入る
pipenv --venv       # pathを確認
```

Macでは`<hoe>/project/.venv`となる。\

インタープリタのアドレスは`<hoe>/project/.venv/bin/python`となる。

仮想環境中にインストールされているパッケージを確認。

```{bash, eval =F}
pipenv run pip freeze
```

ここに**numpyがある**ことが必須。

ない場合は、インストールしておく。

```{bash, eval = F}
pipenv install numpy
```


## R側の準備

```{r, eval = F}
install.packages("tidyverse")   # 初心者は黙って入れよう
install.packages("reticulate")  # R上でPythonを呼び出すインターフェース

library(tidyverse)
library(reticulate)
```

## reticulateことはじめ

#### pathを通して仮想環境を呼び出す。

使いたいPythonインタープリタのpathを変数に取っておいて呼び出す。

```{r, include=F}
python_env <- "/Users/km/python/test/.venv/bin/python"

use_python(python = python_env, required = TRUE)
```

```{r, eval=F}
python_env <- "<hoge>/project/.venv/bin/python"

use_python(python = python_env, required = TRUE)
```


確認。


```{r, eval = F}
py_config()
```

こんな感じの出力になる(はず)。

```{eval = F}
## python:         <hoge>/project/.venv/bin/python
## libpython:      /Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/config-3.7...
## pythonhome:     /Library/Frameworks/Python.framework/Versions/3.7:/Library/...
## virtualenv:     <hoge>/project/.venv/bin/activate_this.py
## version:        3.7.4 (v3.7.4:e09359112e, Jul  8 2019, 14:36:03) ...
## numpy:         <hoge>/project/.venv/lib/python3.7/site-packages/numpy
## numpy_version:  1.16.4
## 
## NOTE: Python version was forced by use_python function
```

**注意**： 一度、Pythonのインタプリタを読み込むと、そのセッションでは異なるインタプリタを指定することはできない。切り替えたい場合はRを再起動(`command + shift + 0`)してセッションをリフレッシュする必要がある。

#### Pythonで定義した関数をR上で使う


Python側で定義した関数を`./python/sample.py`に入れておく。\
(最近のRstudioではFile > NewFileからPython Scriptを選べる)

例えば下記。

```{python, eval = F}
import pandas as pd

def pd_load_csv(path):
  df = pd.read_csv(path)
  return df
  
def pd_head3(df):
  return df.head(3)

def pd_head(df, n = 3):
  return df.head(n)
```

これを使ってデータを変形してみる。

適当なcsvを作っておいて、

```{r, eval =F}
set.seed(71)
N <- 15
data.frame(x = 1:N,
           y = rnorm(N),
           z = sample(letters[1:3], N, replace = TRUE)) %>% 
  write.csv("data/sample1.csv", row.names = F)
```

PythonScript上で定義した関数を使って読み込む。

```{r}
source_python("python/sample.py")

path <- "data/sample1.csv" 

path %>% 
  pd_load_csv() %>% 
  pd_head3()
```

できた！

#### 注意点


ところが、どっこい、これがエラーになる。

```{r, eval = F}
path %>% 
  pd_load_csv() %>% 
  pd_head(3)
```

>  py_call_impl(callable, dots$args, dots$keywords) でエラー: 
  TypeError: cannot do slice indexing on <class 'pandas.core.indexes.range.RangeIndex'> with these indexers [3.0] of <class 'float'> 
  
何やら`[3.0]`の`<vlass float>`で怒られていそうだ。そうかそうか、

```{r, eval = F}
path %>% 
  pd_load_csv() %>% 
  pd_head(3L)
```

これで動く。

という訳で、Rではヨシナにしてくれている変数の型をちゃんとしないとPythonで動かないことがありますよ。

#### R上でPythonのパッケージを読み込んで使う

こんな事もできます。

```{r}
pd <- import("pandas")

pd$array(1:4)
```

これは`pandas`ライブラリで定義された関数をR上で使っています。\
ただ、`pandas`だと実際には読み込んだdata.frame名を使って、`df.head(n)`といった書き方をするので`pd$function`が使いやすい場面はあまりありません。

別の例ですが、opencv-python(`cv2`)を使って、画像の呼び出し・書き込みを行えます。Rの画像処理パッケージ三銃士（`magick`, `EBImage`, `imager`)を使った読み書きの実行時間を調べると...

```{r, eval = F}
library(magick)
library(EBImage)
library(imager)
cv2 <- import("cv2")

path_in <- "./fig/chunk.png"
path_out <- "./fig/chunk1.png"

```

```{r, include=F}
library(magick)
library(EBImage)
library(imager)
library(opencv)
cv2 <- import("cv2")

path_in <- "./fig/chunk.png"
path_out <- "./fig/chunk1.png"

```

```{r, eval=F}
## OpenCV
system.time({
  img <- cv2$imread(path_in)
  cv2$imwrite(path_out, img)
})
```


```{r, echo=F}
system.time({
img <- cv2$imread(path_in)
cv2$imwrite(path_out, img)
})
```

```{r, eval = T}
## magick
system.time({
  img <- image_read(path_in)
  image_write(img, path_out)
})
## EBImage
system.time({
  img <- readImage(path_in)
  writeImage(img, path_out)
})
## imager
system.time({
  img <- load.image(path_in)
  save.image(img, path_out)
})
```

`cv2`が一番早い。（cv2 > magick > EBImage > imager）

ちなみに、Rからもopencvを使うパッケージ`opencv`があって、それも含めてちゃんと比べるとこうなる。

```{r}
library(microbenchmark)
library(opencv)

f_cv2 <- function(path_in, path_out){
  img <- cv2$imread(path_in)
  cv2$imwrite(path_out, img)
}

f_ocv <- function(path_in, path_out){
  img <- ocv_read(path_in)
  ocv_write(img, path_out)
}


f_magick <- function(path_in, path_out){
  img <- image_read(path_in)
  image_write(img, path_out)
}

f_EBImage <- function(path_in, path_out){
  img <- readImage(path_in)
  writeImage(img, path_out)
}

f_imager <- function(path_in, path_out){
  img <- load.image(path_in)
  save.image(img, path_out)
}

mbm <- microbenchmark(
  cv2 = f_cv2(path_in, path_out),
  ocv = f_ocv(path_in, path_out),
  magick = f_magick(path_in, path_out),
  EBimage = f_EBImage(path_in, path_out),
  imager = f_imager(path_in, path_out))
```

```{r, echo=F}
mbm
autoplot(mbm)
```

結果：opencvパッケージのほうが早かったですね...。

#### Rmdで直にPythonを打つ

もっと過激になりましょう。\
Rmarkdownを作って、下記を実行すると...

````
`r ''````{python}
df=pd.read_csv("data/sample1.csv")

df
`r ''````
````

```{python, echo = F}
df=pd.read_csv("data/sample1.csv" )
df.head(3)
```

動きます。

別のチャンクで先ほど定義したpandas dataframeの`df`をそのまま呼び出せます。

````
`r ''````{python}
df.sort_values(by ='z')
`r ''````
````

```{python, echo=F}
df.sort_values(by ='z')
```

それどころかR側の名前空間にアクセスしてオブジェクトを引っ張ってこれます。

````
`r ''````{python}
py_iris=r.iris
py_iris=pd.DataFrame(py_iris)

py_iris.head(3)
`r ''````
````


```{python, echo=F}
py_iris=r.iris
py_iris=pd.DataFrame(py_iris)

py_iris.head(3)
```

R側からもPythonの名前空間を呼び出してオブジェクトを取り扱えます。

```{r}
pyenv <- import_main()
dat <- pyenv$df

dat %>% head
```



## まとめ

・`use_python`でPythonインタープリタのPathを通そう。\
・`source_python`でPythonで定義された関数を読み込めるよ。\
・型注意な。\
・R上で、`reticulate::import()`を使うとPythonパッケージも読み込める。\
・Rmdだと、chunk内でPython打てるんだよ。\
・chunk超えてオブジェクトも受け渡せるし、Rからも呼べる。\
・プレビューも出る!!

## refs

・[R MarkdownでPythonを書こう](https://rpubs.com/nakamichi_/rmd-python)

### 実行環境

```{r, echo =F}
sessionInfo()
```

